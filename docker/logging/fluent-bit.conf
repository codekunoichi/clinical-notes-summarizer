# Fluent Bit Configuration for Clinical Notes Summarizer
# Healthcare-compliant logging with PHI protection

[SERVICE]
    # Basic service configuration
    Flush         5
    Daemon        off
    Log_Level     info
    Parsers_File  parsers.conf
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020
    Health_Check  On
    
    # Healthcare compliance settings
    storage.path              /tmp/flb-storage/
    storage.sync              normal
    storage.checksum          off
    storage.backlog.mem_limit 50M

[INPUT]
    Name              tail
    Path              /var/log/clinical/*.log
    Path_Key          log_file
    Tag               clinical.api
    Refresh_Interval  30
    
    # Healthcare-specific parsing
    Parser            clinical_json
    Key               message
    
    # PHI protection - exclude sensitive patterns
    Exclude_Path      /var/log/clinical/*debug*,/var/log/clinical/*request*
    
    # Buffer settings for healthcare reliability
    Buffer_Chunk_Size 512k
    Buffer_Max_Size   2M
    
    # Skip empty lines and comments
    Skip_Empty_Lines  On

[INPUT]
    Name              tail
    Path              /var/lib/docker/containers/*/*.log
    Path_Key          container_log_file
    Tag               clinical.container
    Refresh_Interval  30
    
    # Docker container log parsing
    Parser            docker
    Key               log
    
    # PHI protection for container logs
    Exclude_Path      *debug*,*request*

[FILTER]
    Name                kubernetes
    Match               clinical.*
    Kube_URL            https://kubernetes.default.svc:443
    Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
    Kube_Tag_Prefix     clinical.
    Merge_Log           On
    Keep_Log            Off
    K8S-Logging.Parser  On
    K8S-Logging.Exclude On

[FILTER]
    Name                modify
    Match               clinical.*
    
    # Add healthcare compliance metadata
    Add                 healthcare_compliant true
    Add                 phi_protected true
    Add                 fhir_version R4
    Add                 service_type clinical_api
    Add                 log_version 1.0
    
    # Add timestamp in ISO format
    Add                 processed_timestamp ${time}

[FILTER]
    Name                grep
    Match               clinical.*
    
    # PHI Protection: Exclude logs with potential PHI patterns
    # This is a defense-in-depth measure
    Exclude             message /(?i)(ssn|social.security|dob|date.of.birth|patient.id|mrn|medical.record)/
    Exclude             message /(?i)(phone|address|email|name|birthdate)/
    Exclude             message /(?i)(\b\d{3}-?\d{2}-?\d{4}\b)/  # SSN pattern
    Exclude             message /(?i)(\b\d{1,2}\/\d{1,2}\/\d{4}\b)/  # Date pattern

[FILTER]
    Name                record_modifier
    Match               clinical.*
    
    # Remove or sanitize potentially sensitive fields
    Remove_key          patient_info
    Remove_key          phi_data
    Remove_key          personal_data
    Remove_key          sensitive_info
    
    # Sanitize user agent and referrer
    Record              user_agent ${user_agent:-sanitized}
    Record              referrer ${referrer:-sanitized}

[FILTER]
    Name                lua
    Match               clinical.*
    Script              phi_sanitizer.lua
    Call                sanitize_clinical_logs

# Healthcare audit log output
[OUTPUT]
    Name                 file
    Match                clinical.api
    Path                 /var/log/clinical/audit/
    File                 clinical-api-audit.log
    Format               json_lines
    
    # Healthcare compliance settings
    Json_date_key        audit_timestamp
    Json_date_format     iso8601
    
    # Rotation for compliance retention
    Rotate_Wait          30
    
    # Security: Ensure proper permissions
    File_Permission      0640

# System monitoring output
[OUTPUT]
    Name                 file
    Match                clinical.container
    Path                 /var/log/clinical/system/
    File                 clinical-system.log
    Format               json_lines
    
    # Container monitoring specific formatting
    Json_date_key        system_timestamp
    Json_date_format     iso8601

# Optional: Forward to external logging system
# Uncomment and configure for production
[OUTPUT]
    Name                 http
    Match                clinical.*
    Host                 your-log-aggregator.example.com
    Port                 443
    URI                  /clinical-logs
    Format               json_lines
    
    # Healthcare security
    tls                  on
    tls.verify           on
    
    # Authentication headers
    Header Authorization Bearer YOUR_LOG_TOKEN_HERE
    Header X-Healthcare-Service clinical-notes-summarizer
    Header X-Compliance HIPAA-Aware
    
    # Retry and buffering for reliability
    Retry_Limit          5
    
    # Rate limiting to prevent overwhelming log servers
    Workers              1

# Healthcare emergency output (if primary fails)
[OUTPUT]
    Name                 file
    Match                clinical.*
    Path                 /var/log/clinical/emergency/
    File                 emergency-backup.log
    Format               json_lines
    
    # Emergency logging settings
    Json_date_key        emergency_timestamp
    Json_date_format     iso8601
    
    # Only activate if other outputs fail
    Match_Regex          .*

# Healthcare compliance notes:
# 1. All logs are PHI-protected through filtering
# 2. Sensitive patterns are excluded at multiple levels
# 3. Audit trails are maintained for compliance
# 4. Emergency backup ensures no log loss
# 5. Structured JSON format for analysis
# 6. Proper file permissions for security
# 7. Rotation policies for retention compliance
# 8. TLS encryption for external forwarding
# 9. Authentication for secure transmission
# 10. Rate limiting to prevent system impact